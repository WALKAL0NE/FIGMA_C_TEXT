<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), clipboard-write=(), display-capture=()">
  <title>Text Style Exporter</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 16px;
      background-color: #fff;
      font-size: 14px;
      color: #333;
      line-height: 1.4;
    }
    
    h1 {
      font-size: 18px;
      font-weight: 600;
      margin: 0 0 16px 0;
      color: #000;
    }
    
    .message {
      padding: 12px;
      background-color: #f5f5f5;
      border-radius: 4px;
      text-align: center;
      color: #666;
      margin-bottom: 16px;
    }
    
    .code-block {
      background-color: #f8f8f8;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      padding: 12px;
      font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.5;
      white-space: pre;
      overflow-x: auto;
      margin-bottom: 16px;
      cursor: text;
      user-select: all;
      min-height: 60px;
    }
    
    .button-container {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    button {
      background-color: #18a0fb;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      flex: 1;
      transition: background-color 0.2s;
    }
    
    button:hover {
      background-color: #0090e7;
    }
    
    button.secondary {
      background-color: #f0f0f0;
      color: #333;
    }
    
    button.secondary:hover {
      background-color: #e0e0e0;
    }
    
    .section {
      margin-bottom: 16px;
      padding: 12px;
      border-radius: 4px;
      border: 1px solid #e0e0e0;
    }
    
    .section h3 {
      margin: 0 0 8px 0;
      font-size: 14px;
      font-weight: 500;
    }
    
    .form-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 8px 0;
    }
    
    label {
      font-size: 12px;
      color: #666;
      min-width: 80px;
    }
    
    input, textarea {
      flex: 1;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
      font-family: inherit;
    }
    
    textarea {
      font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
      resize: vertical;
      min-height: 80px;
    }
    
    input:focus, textarea:focus {
      outline: none;
      border-color: #18a0fb;
    }
    
    .help-text {
      font-size: 11px;
      color: #999;
      margin-top: 4px;
    }
    
    .alias-list {
      margin-top: 8px;
    }
    
    .alias-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      font-size: 12px;
      color: #666;
    }
    
    .alias-item button {
      padding: 2px 8px;
      font-size: 10px;
      flex: none;
      min-width: auto;
    }
  </style>
</head>
<body>
  <h1>Text Style Exporter</h1>
  
  <div id="content">
    <div class="message">
      Select a text element to export its style
    </div>
  </div>

  <script>
    console.log('UI Script loaded');
    
    let currentSassCode = '';
    let currentStyles = null;
    let fontAliases = {};
    let settings = {
      template: '+text($size(rem), $weight, $family)\nletter-spacing: $spacing(em)\nline-height: $lineHeight(%)'
    };
    
    // プラグインとの通信開始
    parent.postMessage({ pluginMessage: { type: 'ui-ready' } }, '*');
    parent.postMessage({ pluginMessage: { type: 'get-aliases' } }, '*');
    parent.postMessage({ pluginMessage: { type: 'get-settings' } }, '*');
    
    function updateSassCode() {
      if (!currentStyles) return;
      
      currentSassCode = applyTemplate(settings.template, currentStyles, fontAliases);
      
      const codeBlock = document.querySelector('.code-block');
      if (codeBlock) {
        codeBlock.textContent = currentSassCode;
      }
    }
    
    function parseTemplate(template) {
      const regex = /\$(size|weight|family|spacing|lineHeight)(?:\(([^)]+)\))?/g;
      const variables = [];
      let match;
      
      while ((match = regex.exec(template)) !== null) {
        variables.push({
          fullMatch: match[0],
          variable: match[1],
          unit: match[2] || 'default'
        });
      }
      
      return variables;
    }
    
    function applyTemplate(template, styles, aliases) {
      const fontFamily = aliases[styles.fontFamily] || `'${styles.fontFamily}'`;
      const variables = parseTemplate(template);
      let result = template;
      
      variables.forEach(({fullMatch, variable, unit}) => {
        let value = '';
        switch (variable) {
          case 'size':
            value = convertFontSize(styles.fontSize, unit);
            break;
          case 'weight':
            value = convertFontWeight(styles.fontWeight, unit);
            break;
          case 'family':
            value = fontFamily;
            break;
          case 'spacing':
            value = convertLetterSpacing(styles.letterSpacing, unit);
            break;
          case 'lineHeight':
            value = convertLineHeight(styles.lineHeight, unit);
            break;
        }
        result = result.replace(fullMatch, value);
      });
      
      return result;
    }
    
    function convertFontSize(value, unit) {
      const numValue = parseFloat(value);
      switch (unit) {
        case 'px': return (numValue * 16).toFixed(0) + 'px';
        case 'rem': return value;
        case 'unitless': return numValue.toFixed(3);
        default: return value;
      }
    }
    
    function convertFontWeight(value, unit) {
      const weightMap = {
        'thin': 100, 'extralight': 200, 'light': 300, 'normal': 400,
        'medium': 500, 'semibold': 600, 'bold': 700, 'extrabold': 800, 'black': 900
      };
      
      switch (unit) {
        case 'number':
        case 'unitless':
          return String(weightMap[value] || 400);
        default:
          return value;
      }
    }
    
    function convertLetterSpacing(value, unit) {
      const numValue = parseFloat(value);
      switch (unit) {
        case '%': return (numValue * 100).toFixed(1) + '%';
        case 'em': return value;
        case 'unitless': return numValue.toFixed(2);
        case 'px': return (numValue * 16).toFixed(1) + 'px';
        default: return value;
      }
    }
    
    function convertLineHeight(value, unit) {
      const numValue = parseFloat(value);
      switch (unit) {
        case '%': return (numValue * 100).toFixed(0) + '%';
        case 'unitless':
        case 'default': return value;
        case 'px': return (numValue * 16).toFixed(0) + 'px';
        default: return value;
      }
    }
    
    function copyToClipboard() {
      const textarea = document.createElement('textarea');
      textarea.value = currentSassCode;
      textarea.style.position = 'absolute';
      textarea.style.left = '-9999px';
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      
      parent.postMessage({ pluginMessage: { type: 'copy-success' } }, '*');
    }
    
    function closePlugin() {
      parent.postMessage({ pluginMessage: { type: 'close' } }, '*');
    }
    
    function updateAliasList() {
      const aliasList = document.getElementById('aliasList');
      if (!aliasList) return;
      
      const aliases = Object.entries(fontAliases);
      if (aliases.length === 0) {
        aliasList.innerHTML = '<div style="color: #999; font-size: 12px;">No aliases defined</div>';
      } else {
        aliasList.innerHTML = aliases.map(([font, alias]) => 
          `<div class="alias-item">
            <span>${font} → ${alias}</span>
            <button onclick="removeAlias('${font}')">Remove</button>
          </div>`
        ).join('');
      }
    }
    
    function removeAlias(font) {
      delete fontAliases[font];
      parent.postMessage({ 
        pluginMessage: { 
          type: 'save-aliases',
          aliases: fontAliases
        } 
      }, '*');
      updateSassCode();
      updateAliasList();
    }
    
    function renderUI() {
      const content = document.getElementById('content');
      
      if (!currentStyles) {
        content.innerHTML = '<div class="message">Select a text element to export its style</div>';
        return;
      }
      
      const aliasValue = fontAliases[currentStyles.fontFamily] || '';
      
      content.innerHTML = `
        <div class="code-block">${currentSassCode}</div>
        
        <div class="button-container">
          <button onclick="copyToClipboard()">Copy SASS Code</button>
          <button class="secondary" onclick="closePlugin()">Close</button>
        </div>
        
        <div class="section">
          <h3>Font Alias</h3>
          <div class="form-row">
            <label>Alias for ${currentStyles.fontFamily}:</label>
            <input type="text" id="aliasInput" value="${aliasValue}" 
                   placeholder="e.g., $font-primary" 
                   oninput="updateAlias(this.value)">
          </div>
          <div class="alias-list" id="aliasList"></div>
        </div>
        
        <div class="section">
          <h3>Settings</h3>
          <div class="form-row">
            <label style="align-self: flex-start; margin-top: 8px;">Template:</label>
            <div style="flex: 1;">
              <textarea id="templateInput" oninput="updateTemplate(this.value)">${settings.template}</textarea>
              <div class="help-text">
                Variables: $size(unit), $weight, $family, $spacing(unit), $lineHeight(unit)<br>
                Units: px, rem, em, %, unitless
              </div>
            </div>
          </div>
        </div>
        
        <div class="section">
          <h3>Extracted Styles</h3>
          <div style="font-size: 12px; color: #666;">
            <div><strong>Font Size:</strong> ${currentStyles.fontSize}</div>
            <div><strong>Font Weight:</strong> ${currentStyles.fontWeight}</div>
            <div><strong>Font Family:</strong> ${currentStyles.fontFamily}</div>
            <div><strong>Letter Spacing:</strong> ${currentStyles.letterSpacing}</div>
            <div><strong>Line Height:</strong> ${currentStyles.lineHeight}</div>
          </div>
        </div>
      `;
      
      updateAliasList();
    }
    
    function updateAlias(value) {
      const trimmedValue = value.trim();
      if (trimmedValue) {
        fontAliases[currentStyles.fontFamily] = trimmedValue;
      } else {
        delete fontAliases[currentStyles.fontFamily];
      }
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'save-aliases',
          aliases: fontAliases
        } 
      }, '*');
      updateSassCode();
      updateAliasList();
    }
    
    function updateTemplate(value) {
      settings.template = value;
      updateSassCode();
      parent.postMessage({ 
        pluginMessage: { 
          type: 'save-settings',
          settings: settings
        } 
      }, '*');
    }
    
    // メッセージ受信処理
    window.onmessage = function(event) {
      console.log('Message received:', event.data);
      const message = event.data.pluginMessage;
      
      if (message.type === 'no-selection' || message.type === 'no-text') {
        currentStyles = null;
        renderUI();
        return;
      }
      
      if (message.type === 'style-extracted') {
        currentStyles = message.styles;
        updateSassCode();
        renderUI();
      }
      
      if (message.type === 'aliases-loaded') {
        fontAliases = message.aliases || {};
        if (currentStyles) {
          updateSassCode();
          renderUI();
        }
      }
      
      if (message.type === 'settings-loaded') {
        settings = message.settings || settings;
        if (currentStyles) {
          updateSassCode();
          renderUI();
        }
      }
    };
  </script>
</body>
</html>